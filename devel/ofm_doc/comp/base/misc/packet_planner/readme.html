<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Packet Planner &mdash; Minimal NDK Application Docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme_overrides.css?v=b530091d" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Event Counter" href="../event_counter/readme.html" />
    <link rel="prev" title="Transaction Sorter" href="../trans_sorter/readme.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Minimal NDK Application Docs
          </a>
              <div class="version">
                Git branch: devel, <br> Git hash: 373448e9
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Application:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../app-minimal.html">Minimal NDK application</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Network Development Kit:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/doc/how_to_start.html">How to start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/doc/terminology.html">NDK Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/intel/readme.html">NDK architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/intel/readme.html#build-system">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/doc/configuration.html">Configuration files and parameters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/doc/testing.html">NDK testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../build/readme.html">Build System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/doc/devtree.html">Device Tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_core/doc/faq.html">Frequently Asked Questions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Supported cards:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/reflexces/agi-fh400g/readme.html">ReflexCES XpressSX AGI-FH400G</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/intel/dk-dev-1sdx-p/readme.html">Intel Stratix 10 DX FPGA DK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/intel/dk-dev-agi027res/readme.html">Intel Agilex I-Series FPGA DK</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/silicom/fb4cgg3/readme.html">Silicom fb4CGg3&#64;VU9P</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/silicom/fb2cghh/readme.html">Silicom fb2CGhh&#64;KU15P</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/silicom/n6010/readme.html">Silicom N6010</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/bittware/ia-420f/readme.html">Bittware IA-420F</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/amd/alveo-u200/readme.html">AMD Alveo U200</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/amd/alveo-u55c/readme.html">AMD Alveo U55C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../ndk_cards/amd/vcu118/readme.html">AMD VCU118&#64;VU9P</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">VHDL components:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../base.html">Basic Tools</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../../async.html">Asynchronous modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../memory.html">Memory modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../fifo.html">FIFO components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../dsp.html">DSP components</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../shift.html">Shift registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../logic.html">Basic logic elements</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../../misc.html">Miscellaneous</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../crossbarx/readme.html">CrossbarX</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trans_sorter/readme.html">Transaction Sorter</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Packet Planner</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="#additional-features">Additional features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../event_counter/readme.html">Event Counter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pulse_short/readme.html">Pulse short</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ctrls.html">Controllers &amp; TSU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mi.html">MI Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mfb.html">MFB Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../mvb.html">MVB Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../nic.html">Network Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../pcie.html">PCIe Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../debug.html">Debug Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../ver.html">UVM Verification</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Minimal NDK Application Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../base.html">Basic Tools</a></li>
          <li class="breadcrumb-item"><a href="../../../../misc.html">Miscellaneous</a></li>
      <li class="breadcrumb-item active">Packet Planner</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/ofm_doc/comp/base/misc/packet_planner/readme.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="packet-planner">
<span id="id1"></span><h1>Packet Planner<a class="headerlink" href="#packet-planner" title="Link to this heading"></a></h1>
<p>The Packet Planner processes input MVB packet headers by assigning addresses to an outside buffer space to each packet, so that they are placed one after another with the needed inter-packet gaps and alignment.
With the help from the input read pointer from the outside buffer it also checks space availability and stops the header input before the buffer overflows.</p>
<p>The user specifies:</p>
<ol class="arabic simple">
<li><p>Size of the target buffer</p></li>
<li><p>Packet alignment</p></li>
<li><p>Average inter-packet gap size</p></li>
<li><p>Minimum inter-packet gap size</p></li>
</ol>
<p>The gap is calculated for each packet using the deficit idle count algorithm.
(When one gap is over average size because of alignment, the next gap can be below average. But never below minimum.)</p>
<p>The calculated gap size allows the Packet Planner to set a address to the target buffer for each packet.
After this the packets are checked for buffer overflow.
To be able to check amount of free space in the buffer, the unit needs the current read pointer from the buffer.
This pointer shifts when data (packets previously planned by the Packet Planner) have been freed from the buffer.
The Packet Planner itself propagates its internal write pointer to the user.
This is meant mainly for debug purposes.
You can also use it to simulate an infinite target buffer space by connecting it directly back as the read pointer.</p>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading"></a></h2>
<a class="reference internal image-reference" href="../../../../../_images/packet_planner.svg" id="packet-planner-diagram"><img alt="" class="align-center" id="packet-planner-diagram" src="../../../../../_images/packet_planner.svg" style="width: 100%;" /></a>
<p>The Packet Planner receives multiple input packet headers from multiple independent interfaces (<em>Streams</em>).
Since all the pakcets are planned to a single linear buffer space, they are all serialized in a single input FIFOX Multi and processed as one stream of headers.
On the output the packets are distributed back to to the original <em>Stream</em>.
Each <em>Stream</em> has its own output FIFOX Multi.
Sometimes it is useful to have all the packets available in the global order as well (for example when working with the data in the target buffer).
For this reason the Packet Planner also provides an interfaces with output FIFOX Multi with headers from all <em>Streams</em> in the serialized order.
Thus each output header is sent to the global output as well as one of the stream outputs.
The global and the stream output interfaces are both optional and can be switched using generics <code class="docutils literal notranslate"><span class="pre">GLOBAL_OUT_EN</span></code> and <code class="docutils literal notranslate"><span class="pre">STREAM_OUT_EN</span></code>.</p>
<p>The unit processes multiple headers in parallel an is thus heavily pipelined to be able to reach high clock frequencies.
Appart from the FIFOX Multis it contains a total of 5 pipeline stages (0 to 4).
Here is the description of each stage:</p>
<ol class="arabic simple" start="0">
<li><p>Here the input data is stopped depending on the Almost Full propagated from the other end of the pipeline.
The Almost Full offsets must be set in a way to still contain all headers, which could be present from register Reg0 to Reg4.</p></li>
<li><p>Calculation of inter-packet gaps.
The size of each gaps depends on the length of the packet and the gap size of the previous packet.
To eliminate the dependency between packets processed in the same cycle, a special component is used for the deficit idle count algorithm.
This unit aproximates the ideal algorithm by distributing the deficit from the previous set of packets over all current packets evenly without taking into account the deficit generated by the current packets until the next cycle.</p></li>
<li><p>Calculation of target buffer address.
The unit has an internal write pointer register to store the address shift from previous packets.
The address of each packet depends on its length, the size of inter-packet gap before it and the address of the previous packet.
Here the dependency between parallel headers could not be avoided, which makes it the most possible performance bottleneck.</p></li>
<li><p>Calculation of total sum of space taken by the packets in the target packet (from the start og the first one to the end of the last one).</p></li>
<li><p>Checking of available space in the target buffer.
If all the packets fit in the buffer, they are let through.
Otherwise the pipeline is stopped until the buffer read pointer shifts enough for the packets to fit.</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Because multiple packets are processed at the same time and can only be passed through Step 4 all at once, a deadlock can occur if only some of the packets fit into an empty buffer, but not all.
To avoid this, the component has additional logic in Step 0.
The process reading packet headers from the input FIFOX Multi checks if their one-by-one accumulated length reaches the size of one buffer word.
If so, no more headers are read from the FIFOX Multi in this cycle.
(e.g. If there are 4 20-byte packets available at the FIFOX Multi output and the size of one buffer word is 32 bytes, only the first 2 packets will be passed to Reg0.)
This way the available space checking cannot deadlock if the target buffer is large enough to contain at least: 1 word - 1 + 1 maximum-sized gap + 1 maximum-sized packet (worst case amount of space taken by packets processed in one cycle).
This fix should not lead to any throughput reduction considering the data in the buffer itself are only processed one word each cycle.</p>
</div>
</section>
<section id="additional-features">
<h2>Additional features<a class="headerlink" href="#additional-features" title="Link to this heading"></a></h2>
<p>Because the component has FIFOX Multis on its input and outputs, the number of parallel headers processed in the internal pipeline can be set independently with generic <code class="docutils literal notranslate"><span class="pre">PLANNED_PKTS</span></code>.
This may allow the user to reduce internal logic complexity at the cost of throughput for small packets.</p>
<p>The internal pipeline is enabled by Almost Full signals from the output FIFOs.
Using generics <code class="docutils literal notranslate"><span class="pre">STREAM_OUT_AFULL</span></code> and <code class="docutils literal notranslate"><span class="pre">GLOBAL_OUT_AFULL</span></code> you can remove these FIFOs and generate the Almost Full signal yourself.
This will save you resources in cas you already have a FIFO placed somewhere after this component.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<p>For more detailed description refer to Jan Kubalek’s <a class="reference external" href="https://www.fit.vut.cz/study/thesis-file/22958/22958.pdf">thesis</a> 2019/20.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../trans_sorter/readme.html" class="btn btn-neutral float-left" title="Transaction Sorter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../event_counter/readme.html" class="btn btn-neutral float-right" title="Event Counter" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, CESNET z.s.p.o..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>